@page "/today"
@using System
@using System.Linq
@using Microsoft.AspNetCore.Components
@using JournalApp.Models
@using JournalApp.Services
@using Markdig
@inject JournalService JournalService

<h1>Today's Journal</h1>

@if (loading)
{
    <p style="color:var(--text-color);">Loading...</p>
}
else
{
    <div style="display:flex; gap:16px; flex-wrap:wrap; max-width:1200px; margin:20px auto;">
        <!-- LEFT PANEL -->
        <div style="flex:1; min-width:340px;">

            <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--text-color);">Title (supports #tags)</label>
            <input style="width:100%; padding:10px; border:2px solid var(--border-color); border-radius:6px; background:var(--background-color); color:var(--text-color); font-size:1em;" @bind="entry.Title" />

            <div style="margin:16px 0;"></div>

            <!-- Mood -->
            <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--text-color);">Primary Mood</label>
            <select style="width:100%; padding:10px; border:2px solid var(--border-color); border-radius:6px; background:var(--background-color); color:var(--text-color); font-size:1em;" @bind="entry.PrimaryMood">
                @foreach (var m in AllMoods)
                {
                    <option value="@m">@m</option>
                }
            </select>

            <div style="margin:16px 0;"></div>

            <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--text-color);">Secondary Mood 1</label>
            <select style="width:100%; padding:10px; border:2px solid var(--border-color); border-radius:6px; background:var(--background-color); color:var(--text-color); font-size:1em;" @bind="entry.SecondaryMood1">
                <option value="">(None)</option>
                @foreach (var m in AllMoods)
                {
                    <option value="@m">@m</option>
                }
            </select>

            <div style="margin:16px 0;"></div>

            <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--text-color);">Secondary Mood 2</label>
            <select style="width:100%; padding:10px; border:2px solid var(--border-color); border-radius:6px; background:var(--background-color); color:var(--text-color); font-size:1em;" @bind="entry.SecondaryMood2">
                <option value="">(None)</option>
                @foreach (var m in AllMoods)
                {
                    <option value="@m">@m</option>
                }
            </select>

            <div style="margin:16px 0;"></div>

            <!-- Tags -->
            <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--text-color);">Tags</label>
            <div style="border:2px solid var(--border-color); padding:12px; border-radius:6px; max-height:160px; overflow:auto; background:var(--sidebar-background);">
                @foreach (var tag in PredefinedTags)
                {
                    <div style="margin-bottom:6px; color:var(--text-color);">
                        <input type="checkbox"
                               checked="@selectedTags.Contains(tag)"
                               @onchange="e => ToggleTag(tag, (bool)e.Value!)" />
                        <span style="margin-left:6px;">@tag</span>
                    </div>
                }
            </div>

            <div style="margin:12px 0;"></div>

            <input placeholder="Add custom tag"
                   style="padding:8px; width:70%; border:2px solid var(--border-color); border-radius:6px; background:var(--background-color); color:var(--text-color);"
                   @bind="newTag" />
            <button style="padding:8px 12px; margin-left:6px; background:var(--primary-color); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:500;" @onclick="AddCustomTag">Add</button>

            @if (selectedTags.Any())
            {
                <p style="margin-top:8px; color:var(--text-color);"><b>Selected:</b> @string.Join(", ", selectedTags)</p>
            }

            <div style="margin:16px 0;"></div>

            <!-- Markdown Editor -->
            <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--text-color);">Write (Markdown)</label>

            <div style="display:flex; gap:6px; margin-bottom:10px; flex-wrap:wrap;">
                <button style="padding:6px 12px; border-radius:6px; border:1px solid var(--border-color); background:var(--sidebar-background); color:var(--text-color); cursor:pointer; font-size:0.9rem; font-weight:600; transition:all 0.15s;" @onclick="@(() => InsertMarkdown("**", "**"))">B</button>
                <button style="padding:6px 12px; border-radius:6px; border:1px solid var(--border-color); background:var(--sidebar-background); color:var(--text-color); cursor:pointer; font-size:0.9rem; font-weight:600; transition:all 0.15s;" @onclick="@(() => InsertMarkdown("_", "_"))">I</button>
                <button style="padding:6px 12px; border-radius:6px; border:1px solid var(--border-color); background:var(--sidebar-background); color:var(--text-color); cursor:pointer; font-size:0.9rem; font-weight:600; transition:all 0.15s;" @onclick="@(() => InsertMarkdown("## ", ""))">H</button>
                <button style="padding:6px 12px; border-radius:6px; border:1px solid var(--border-color); background:var(--sidebar-background); color:var(--text-color); cursor:pointer; font-size:0.9rem; font-weight:600; transition:all 0.15s;" @onclick="@(() => InsertMarkdown("- ", ""))">List</button>
                <button style="padding:6px 12px; border-radius:6px; border:1px solid var(--border-color); background:var(--sidebar-background); color:var(--text-color); cursor:pointer; font-size:0.9rem; font-weight:600; transition:all 0.15s;" @onclick="@(() => InsertMarkdown("> ", ""))">Quote</button>
                <button style="padding:6px 12px; border-radius:6px; border:1px solid var(--border-color); background:var(--sidebar-background); color:var(--text-color); cursor:pointer; font-size:0.9rem; font-weight:600; transition:all 0.15s;" @onclick="@(() => InsertMarkdown("[", "](url)"))">Link</button>
            </div>

            <textarea style="width:100%; height:220px; padding:10px; border:2px solid var(--border-color); border-radius:6px; background:var(--background-color); color:var(--text-color); font-size:1em; font-family:monospace;"
                      @bind="entry.Content"></textarea>

            <div style="margin:16px 0;"></div>

            <button style="padding:10px 20px; background:var(--primary-color); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;" @onclick="SaveAsync">Save</button>
            <button style="padding:10px 20px; margin-left:8px; background:#f44336; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;" @onclick="DeleteAsync">Delete</button>

            @if (!string.IsNullOrWhiteSpace(message))
            {
                <p style="margin-top:12px; color:@(message.Contains("success") ? "#4caf50" : "#f44336"); font-weight:500;">@message</p>
            }
        </div>

        <!-- RIGHT PANEL - PREVIEW -->
        <div style="flex:1; min-width:340px;">
            <h2 style="margin-top:0; color:var(--heading-color);">Preview</h2>
            <div style="border:2px solid var(--border-color); padding:16px; border-radius:8px; background:var(--sidebar-background); color:var(--text-color); min-height:400px;">
                @((MarkupString)MarkdownToHtml(entry.Content))
            </div>
        </div>
    </div>
}

@code {
    private JournalEntry entry = new();
    private bool loading = true;
    private string message = "";
    private string newTag = "";
    private List<string> selectedTags = new();

    private readonly string[] AllMoods =
    {
        "Happy","Excited","Relaxed","Grateful","Confident",
        "Calm","Thoughtful","Curious","Nostalgic","Bored",
        "Sad","Angry","Stressed","Lonely","Anxious"
    };

    private readonly string[] PredefinedTags =
    {
        "Work","Career","Studies","Family","Friends","Health",
        "Fitness","Personal Growth","Self-care","Travel","Reflection"
    };

    protected override async Task OnInitializedAsync()
    {
        var today = DateOnly.FromDateTime(DateTime.Now);
        var existing = await JournalService.GetByDateAsync(today);

        entry = existing ?? new JournalEntry
        {
            EntryDate = today,
            PrimaryMood = "Calm"
        };

        if (entry.Tags?.Any() == true)
            selectedTags = entry.Tags.Select(t => t.Name).ToList();

        loading = false;
    }

    private void InsertMarkdown(string prefix, string suffix)
    {
        entry.Content ??= "";
        entry.Content += prefix + suffix;
    }

    private void ToggleTag(string tag, bool isChecked)
    {
        if (isChecked && !selectedTags.Contains(tag))
            selectedTags.Add(tag);
        else if (!isChecked)
            selectedTags.Remove(tag);
    }

    private void AddCustomTag()
    {
        if (string.IsNullOrWhiteSpace(newTag)) return;
        var clean = char.ToUpper(newTag.Trim()[0]) + newTag.Trim()[1..];
        if (!selectedTags.Contains(clean))
            selectedTags.Add(clean);
        newTag = "";
    }

    private List<string> ExtractTagsFromTitle(string title)
    {
        return title.Split(' ')
            .Where(t => t.StartsWith("#") && t.Length > 1)
            .Select(t => char.ToUpper(t[1]) + t[2..])
            .Distinct()
            .ToList();
    }

    private async Task SaveAsync()
    {
        var titleTags = ExtractTagsFromTitle(entry.Title);
        foreach (var t in titleTags)
            if (!selectedTags.Contains(t))
                selectedTags.Add(t);

        var saved = await JournalService.UpsertAsync(entry);
        await JournalService.UpdateTagsAsync(saved, selectedTags);

        message = "Saved successfully";
    }

    private async Task DeleteAsync()
    {
        await JournalService.DeleteByDateAsync(entry.EntryDate);
        entry = new JournalEntry { EntryDate = entry.EntryDate, PrimaryMood = "Calm" };
        selectedTags.Clear();
        message = "Deleted successfully";
    }

    private static string MarkdownToHtml(string md)
    {
        if (string.IsNullOrWhiteSpace(md)) return "";
        var pipeline = new MarkdownPipelineBuilder().UseAdvancedExtensions().Build();
        return Markdig.Markdown.ToHtml(md, pipeline);
    }
}
