@page "/export"
@using JournalApp.Models
@using JournalApp.Services
@inject PdfExportService PdfExportService
@inject NavigationManager Navigation

<h1>Export Journal to PDF</h1>

<div style="max-width:700px; margin:20px auto;">
    <p style="color: var(--secondary-color); font-size:1.05em; margin-bottom:30px;">
        Select a date range to export your journal entries as a PDF file.
    </p>

    <div style="background:var(--background-color); border:2px solid var(--border-color); border-radius:12px; padding:28px; margin-bottom:24px;">
        <form @onsubmit="HandleExport">
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-size:1em; font-weight:600; color:var(--text-color);">Start Date</label>
                <input type="date"
                       class="form-control"
                       @bind="startDate"
                       required
                       style="width:100%; padding:10px; border:2px solid var(--border-color); border-radius:8px; background:var(--background-color); color:var(--text-color); font-size:1em;" />
            </div>

            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-size:1em; font-weight:600; color:var(--text-color);">End Date</label>
                <input type="date"
                       class="form-control"
                       @bind="endDate"
                       required
                       style="width:100%; padding:10px; border:2px solid var(--border-color); border-radius:8px; background:var(--background-color); color:var(--text-color); font-size:1em;" />
            </div>

            <button type="submit"
                    style="
                    width:100%;
                    padding:12px 20px;
                    background:var(--primary-color);
                    color:white;
                    border:none;
                    border-radius:8px;
                    cursor:pointer;
                    font-size:1em;
                    font-weight:600;
                    transition:opacity 0.3s ease;
                "
                    disabled="@isExporting"
                    onmouseover="!@isExporting && (this.style.opacity='0.9')"
                    onmouseout="!@isExporting && (this.style.opacity='1')">
                @if (isExporting)
                {
                    <span>Exporting...</span>
                }
                else
                {
                    <span>Export to PDF</span>
                }
            </button>
        </form>

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div style="background:rgba(76, 175, 80, 0.1); border:1px solid #4caf50; color:#2e7d32; padding:12px 16px; border-radius:8px; margin-top:16px; font-weight:500;">
                ? Success! @successMessage
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div style="background:rgba(244, 67, 54, 0.1); border:1px solid #f44336; color:#c62828; padding:12px 16px; border-radius:8px; margin-top:16px; font-weight:500;">
                ? Error: @errorMessage
            </div>
        }
    </div>

    <div style="background:var(--sidebar-background); border:2px solid var(--border-color); border-radius:12px; padding:20px; margin-bottom:24px;">
        <h3 style="margin:0 0 16px 0; color:var(--heading-color);">About PDF Export</h3>
        <ul style="margin:0; padding-left:20px; color:var(--text-color);">
            <li style="margin-bottom:10px;">Select the start and end dates for the entries you want to export</li>
            <li style="margin-bottom:10px;">Your entries will be formatted into a professional PDF document</li>
            <li style="margin-bottom:10px;">Each entry will appear on its own page with all details including moods, categories, and tags</li>
            <li>The PDF will be saved to your device's storage</li>
        </ul>
    </div>
</div>

@code {
    private DateOnly startDate = DateOnly.FromDateTime(DateTime.Now.AddDays(-30));
    private DateOnly endDate = DateOnly.FromDateTime(DateTime.Now);
    private bool isExporting = false;
    private string? successMessage;
    private string? errorMessage;

    private async Task HandleExport()
    {
        if (startDate > endDate)
        {
            errorMessage = "Start date must be before or equal to end date.";
            return;
        }

        isExporting = true;
        successMessage = null;
        errorMessage = null;

        try
        {
            var result = await PdfExportService.ExportToPdfAsync(startDate, endDate);

            if (result.StartsWith("success:"))
            {
                var filePath = result.Substring(8);
                successMessage = $"File saved to: {filePath}";
            }
            else if (result.StartsWith("error:"))
            {
                errorMessage = result.Substring(6);
            }
            else
            {
                errorMessage = "An unexpected error occurred during export.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Export failed: {ex.Message}";
        }
        finally
        {
            isExporting = false;
        }
    }
}
