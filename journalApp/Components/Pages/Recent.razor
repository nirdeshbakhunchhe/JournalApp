@page "/recent"
@using JournalApp.Models
@using JournalApp.Services
@inject JournalService JournalService
@inject NavigationManager Navigation

<h3>Recent Journal Entries</h3>

@if (loading)
{
    <p>Loading...</p>
}
else if (entries.Count == 0)
{
    <div style="text-align:center; padding:40px;">
        <p style="font-size:1.2em; color:#666;">No journal entries yet.</p>
        <button style="padding:10px 20px; margin-top:20px;" @onclick='() => Navigation.NavigateTo("/today")'>
            Create Your First Entry
        </button>
    </div>
}
else
{
    <!-- Entries List -->
    <div style="margin-bottom:20px;">
        @foreach (var entry in entries)
        {
            <div style="border:1px solid #ddd; border-radius:8px; padding:16px; margin-bottom:16px; cursor:pointer; transition: box-shadow 0.2s;"
                 @onclick="() => ViewEntry(entry.EntryDate)"
                 onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'"
                 onmouseout="this.style.boxShadow='none'">

                <!-- Date -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h4 style="margin:0; color:#333;">@entry.Title</h4>
                    <span style="color:#666; font-size:0.9em;">@entry.EntryDate.ToString("MMM dd, yyyy")</span>
                </div>

                <!-- Moods -->
                <div style="margin-bottom:12px;">
                    <span style="background:#e3f2fd; color:#1976d2; padding:4px 12px; border-radius:12px; font-size:0.85em; margin-right:6px;">
                        @entry.PrimaryMood
                    </span>
                    @if (!string.IsNullOrEmpty(entry.SecondaryMood1))
                    {
                        <span style="background:#f3e5f5; color:#7b1fa2; padding:4px 12px; border-radius:12px; font-size:0.85em; margin-right:6px;">
                            @entry.SecondaryMood1
                        </span>
                    }
                    @if (!string.IsNullOrEmpty(entry.SecondaryMood2))
                    {
                        <span style="background:#fff3e0; color:#e65100; padding:4px 12px; border-radius:12px; font-size:0.85em;">
                            @entry.SecondaryMood2
                        </span>
                    }
                </div>

                <!-- Preview Content -->
                <p style="color:#555; margin:0; line-height:1.5;">
                    @GetPreview(entry.Content)
                </p>

                <!-- Category & Tags -->
                @if (!string.IsNullOrEmpty(entry.Category) || (entry.Tags != null && entry.Tags.Count > 0))
                {
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid #eee; display:flex; gap:12px; flex-wrap:wrap; font-size:0.85em;">
                        @if (!string.IsNullOrEmpty(entry.Category))
                        {
                            <span style="color:#666;">
                                📁 @entry.Category
                            </span>
                        }
                        @if (entry.Tags != null && entry.Tags.Count > 0)
                        {
                            <span style="color:#666;">
                                🏷️ @string.Join(", ", entry.Tags.Select(t => t.Name))
                            </span>
                        }
                    </div>
                }
            </div>
        }
    </div>

    <!-- Pagination -->
    <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-top:30px;">
        <button style="padding:8px 16px;"
                disabled="@(currentPage == 1)"
                @onclick="PreviousPage">
            ← Previous
        </button>

        <span style="color:#666;">
            Page @currentPage of @totalPages
        </span>

        <button style="padding:8px 16px;"
                disabled="@(currentPage >= totalPages)"
                @onclick="NextPage">
            Next →
        </button>
    </div>

    <!-- Page Size Selector -->
    <div style="text-align:center; margin-top:16px;">
        <label style="color:#666; font-size:0.9em;">
            Entries per page:
            <select style="margin-left:8px; padding:4px 8px;" @bind="pageSize" @bind:after="LoadEntriesAsync">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
            </select>
        </label>
    </div>
}

@code {
    private List<JournalEntry> entries = new();
    private bool loading = true;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntriesAsync();
    }

    private async Task LoadEntriesAsync()
    {
        try
        {
            loading = true;
            entries = await JournalService.GetRecentAsync(currentPage, pageSize);

            // Calculate total pages (rough estimate - you'd need a count method in service for exact)
            // For now, if we get less than pageSize, we're on the last page
            if (entries.Count < pageSize && currentPage > 1)
            {
                totalPages = currentPage;
            }
            else if (entries.Count == pageSize)
            {
                // There might be more pages
                totalPages = currentPage + 1;
            }
            else
            {
                totalPages = 1;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading entries: {ex.Message}");
            entries = new();
        }
        finally
        {
            loading = false;
        }
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadEntriesAsync();
        }
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadEntriesAsync();
        }
    }

    private void ViewEntry(DateOnly date)
    {
        // Navigate to edit page with date parameter
        Navigation.NavigateTo($"/edit/{date:yyyy-MM-dd}");
    }

    private string GetPreview(string content)
    {
        if (string.IsNullOrEmpty(content))
            return "No content";

        // Remove markdown symbols for preview
        var preview = content
            .Replace("#", "")
            .Replace("*", "")
            .Replace("_", "")
            .Replace("`", "")
            .Replace(">", "")
            .Replace("-", "")
            .Trim();

        // Take first 150 characters
        if (preview.Length > 150)
            return preview.Substring(0, 150) + "...";

        return preview;
    }
}
