@page "/recent"
@using JournalApp.Models
@using JournalApp.Services
@inject JournalService JournalService
@inject NavigationManager Navigation

<h1>Recent Journal Entries</h1>

@if (loading)
{
    <p style="color:var(--text-color);">Loading...</p>
}
else if (entries.Count == 0)
{
    <div style="text-align:center; padding:40px;">
        <p style="font-size:1.2em; color:var(--secondary-color);">No journal entries yet.</p>
        <button style="padding:12px 24px; margin-top:20px; background:var(--primary-color); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;" @onclick='() => Navigation.NavigateTo("/today")'>
            Create Your First Entry
        </button>
    </div>
}
else
{
    <!-- Entries List -->
    <div style="max-width:900px; margin:20px auto;">
        @foreach (var entry in entries)
        {
            <div style="border:2px solid var(--border-color); border-radius:8px; padding:20px; margin-bottom:16px; cursor:pointer; transition: all 0.2s; background:var(--sidebar-background);"
                 @onclick="() => ViewEntry(entry.EntryDate)"
                 onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'; this.style.borderColor='var(--primary-color)';"
                 onmouseout="this.style.boxShadow='none'; this.style.borderColor='var(--border-color)';">

                <!-- Date & Title -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h3 style="margin:0; color:var(--heading-color);">@entry.Title</h3>
                    <span style="color:var(--text-secondary); font-size:0.9em;">@entry.EntryDate.ToString("MMM dd, yyyy")</span>
                </div>

                <!-- Moods -->
                <div style="margin-bottom:12px; display:flex; gap:6px; flex-wrap:wrap;">
                    <span style="background:var(--primary-color); color:white; padding:4px 12px; border-radius:12px; font-size:0.85em; font-weight:500;">
                        @entry.PrimaryMood
                    </span>
                    @if (!string.IsNullOrEmpty(entry.SecondaryMood1))
                    {
                        <span style="background:var(--accent-color); color:white; padding:4px 12px; border-radius:12px; font-size:0.85em; font-weight:500;">
                            @entry.SecondaryMood1
                        </span>
                    }
                    @if (!string.IsNullOrEmpty(entry.SecondaryMood2))
                    {
                        <span style="background:var(--primary-color); color:white; padding:4px 12px; border-radius:12px; font-size:0.85em; font-weight:500;">
                            @entry.SecondaryMood2
                        </span>
                    }
                </div>

                <!-- Preview Content -->
                <p style="color:var(--text-color); margin:12px 0; line-height:1.6;">
                    @GetPreview(entry.Content)
                </p>

                <!-- Category & Tags -->
                @if (!string.IsNullOrEmpty(entry.Category) || (entry.Tags != null && entry.Tags.Count > 0))
                {
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border-color); display:flex; gap:12px; flex-wrap:wrap; font-size:0.85em;">
                        @if (!string.IsNullOrEmpty(entry.Category))
                        {
                            <span style="color:var(--text-secondary);">
                                📁 @entry.Category
                            </span>
                        }
                        @if (entry.Tags != null && entry.Tags.Count > 0)
                        {
                            <span style="color:var(--text-secondary);">
                                🏷️ @string.Join(", ", entry.Tags.Select(t => t.Name))
                            </span>
                        }
                    </div>
                }
            </div>
        }
    </div>

    <!-- Pagination -->
    <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-top:30px; flex-wrap:wrap;">
        <button style="padding:10px 16px; background:var(--primary-color); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:500;"
                disabled="@(currentPage == 1)"
                @onclick="PreviousPage">
            Previous
        </button>

        <span style="color:var(--text-color); font-weight:500;">
            Page @currentPage of @totalPages
        </span>

        <button style="padding:10px 16px; background:var(--primary-color); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:500;"
                disabled="@(currentPage >= totalPages)"
                @onclick="NextPage">
            Next
        </button>
    </div>

    <!-- Page Size Selector -->
    <div style="text-align:center; margin-top:24px;">
        <label style="color:var(--text-color); font-size:0.95em; font-weight:500;">
            Entries per page:
            <select style="margin-left:8px; padding:6px 10px; background:var(--background-color); color:var(--text-color); border:2px solid var(--border-color); border-radius:4px;" @bind="pageSize" @bind:after="LoadEntriesAsync">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
            </select>
        </label>
    </div>
}

@code {
    private List<JournalEntry> entries = new();
    private bool loading = true;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntriesAsync();
    }

    private async Task LoadEntriesAsync()
    {
        try
        {
            loading = true;
            entries = await JournalService.GetRecentAsync(currentPage, pageSize);

            // Calculate total pages (rough estimate - you'd need a count method in service for exact)
            // For now, if we get less than pageSize, we're on the last page
            if (entries.Count < pageSize && currentPage > 1)
            {
                totalPages = currentPage;
            }
            else if (entries.Count == pageSize)
            {
                // There might be more pages
                totalPages = currentPage + 1;
            }
            else
            {
                totalPages = 1;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading entries: {ex.Message}");
            entries = new();
        }
        finally
        {
            loading = false;
        }
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadEntriesAsync();
        }
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadEntriesAsync();
        }
    }

    private void ViewEntry(DateOnly date)
    {
        // Navigate to edit page with date parameter
        Navigation.NavigateTo($"/edit/{date:yyyy-MM-dd}");
    }

    private string GetPreview(string content)
    {
        if (string.IsNullOrEmpty(content))
            return "No content";

        // Remove markdown symbols for preview
        var preview = content
            .Replace("#", "")
            .Replace("*", "")
            .Replace("_", "")
            .Replace("`", "")
            .Replace(">", "")
            .Replace("-", "")
            .Trim();

        // Take first 150 characters
        if (preview.Length > 150)
            return preview.Substring(0, 150) + "...";

        return preview;
    }
}
